<!DOCTYPE html>
<html lang="es">

    <head>

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>Matricula</title>
        <!-- Custom fonts for this template-->
        <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
        <link
            href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
            rel="stylesheet">

        <!-- Custom styles for this template-->
        <link href="css/sb-admin-2.min.css" rel="stylesheet">

        <!-- Custom styles for this page -->
        <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">

        <link href="css/showLoading.css" rel="stylesheet" type="text/css"/>
    </head>

    <body id="page-top">
        <div class="transparentCover"></div>
        <div class="loading"></div>


        <!-- Page Wrapper -->
        <div id="wrapper">

            <div id="divsidebar"></div>


            <!-- Content Wrapper -->
            <div id="content-wrapper" class="d-flex flex-column">

                <!-- Main Content -->
                <div id="content">

                    <!-- Topbar -->
                    <div id="topbar"></div>

                    <!-- Begin Page Content -->
                    <div class="container-fluid">

                        <br/>
                        <div class="card">
                            <div class="card-body">
                                <center> <h3 class="card-title">Gestión de Aulas</h3></center>

                                <div class="row">

                                    <div class="col-12">

                                        <!-- Circle Buttons -->
                                        <div class="card shadow mb-4">
                                            <div class="card-header py-3">
                                                <h6 class="m-0 font-weight-bold text-primary">Listado de aulas disponibles</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-sm-4 col-md-2 col-lg-2">
                                                        Año:
                                                    </div>
                                                    <div class="col-sm-4 col-md-2 col-lg-2">
                                                        <select id="cmbAnio" class="form-control form-control-user" ></select>
                                                    </div>
                                                </div><br/>
                                                <div class="table-responsive">
                                                    <table id="example" class="table table-striped table-bordered" style="width:100%">
                                                        <thead>
                                                            <tr>
                                                                <th>Codigo</th>   
                                                                <th>Aula</th>   
                                                                <th>Sede</th>                                                                   
                                                                <th>Aforo</th>                                                                   
                                                                <th>Acción</th>                                                              
                                                            </tr>
                                                        </thead>

                                                    </table>
                                                </div>
                                                <button id="btnNuevo" class="btn btn-primary btn-user">Agregar</button>

                                                <!-- Circle Buttons (Default) -->                    

                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <br/>
                    </div>
                    <!-- /.container-fluid -->

                </div>
                <!-- End of Main Content -->

                <!-- Footer -->
                <div id="footer"></div>
                <!-- End of Footer -->

            </div>
            <!-- End of Content Wrapper -->
        </div>

        <!-- Nuevo Aula Modal-->
        <div class="modal fade" id="modalModificar" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTituloAula">Modificar Aula</h5>
                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                        <input type="hidden" 
                               id="txtAccion" value="1">
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col">
                                <div class="form-group">Código:
                                    <input type="text" class="form-control form-control-user"
                                           id="txtCodigo" value="Automático" readonly>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">Año:
                                    <input type="hidden" id="txtCodiAnio" >
                                    <input type="text" class="form-control form-control-user"
                                           id="txtAnio" value="" readonly>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">Sede:
                                    <select name="cmbSede" class="form-control form-control-user"
                                            id="cmbSede">
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">

                            <div class="col-6">
                                <div class="form-group">Grado:
                                    <select name="cmbGrado" class="form-control form-control-user"
                                            id="cmbGrado">
                                    </select>
                                </div>
                            </div> 
                            <div class="col-3">
                                <div class="form-group">Seccion:
                                    <select name="cmbSeccion" class="form-control form-control-user"
                                            id="cmbSeccion">
                                    </select>
                                </div>
                            </div> 
                            <div class="col-3">
                                <div class="form-group">Aforo:
                                    <input type="number" class="form-control form-control-user"
                                           id="txtAforo" value="30" >
                                </div>
                            </div> 
                        </div>

                        <div class="alert alert-danger" id="alertModificar" style="display:none;" role="alert">                            
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancelar</button>
                        <a class="btn btn-primary" id="btnAceptarCambios">Aceptar</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logout Modal-->
        <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">¿Realmente quiere Salir?</h5>
                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div class="modal-body">Haga clic en Aceptar para Cerrar Sesión.</div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancelar</button>
                        <a class="btn btn-primary" id="salir">Salir</a>
                    </div>
                </div>
            </div>
        </div>




        <!-- Bootstrap core JavaScript-->
        <script src="vendor/jquery/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>


        <!-- Custom scripts for all pages-->
        <script src="js/sb-admin-2.min.js"></script>
        <script src="vendor/datatables/jquery.dataTables.min.js" type="text/javascript"></script>

        <script>
            let table, codiUsua, ip, hostname;

            $(document).ready(function () {
                $.getJSON('http://localhost:8080/Matricula/obteneripyhost', function (data) {                    
                    ip=data.ipAddress;
                    hostname=data.hostName;  
                }).fail(function (error) {
                    ip='iperror';
                    hostname='hosterror';
                });
                $.getJSON("validarsesion", function (data) {
                    codiUsua = data.codi;
                    if (data.resultado === "ok") {
                        //CARGA DE INTERFACES
                        $('#topbar').load('topbar.html');
                        $('#sidebar').load('sidebar.html');
                        $('#footer').load('footer.html');


                        //CONFIGUAR LA TABLA
                        table = $('#example').DataTable({
                            language: {
                                decimal: "",
                                emptyTable: "No hay datos",
                                info: "Mostrando desde el _START_ al _END_ del total de _TOTAL_ registros",
                                infoEmpty: "Mostrando desde el 0 al 0 del total de  0 registros",
                                infoFiltered: "(Filtrados del total de _MAX_ registros)",
                                infoPostFix: "",
                                thousands: ",",
                                lengthMenu: "Mostrar _MENU_ registros por página",
                                loadingRecords: "Cargando...",
                                processing: "Procesando...",
                                search: "Buscar:",
                                zeroRecords: "No se ha encontrado nada  atraves de ese filtrado.",
                                paginate: {
                                    first: "Primero",
                                    last: "Última",
                                    next: "Siguiente",
                                    previous: "Anterior"
                                },
                                aria: {
                                    sortAscending: ": activate to sort column ascending",
                                    sortDescending: ": activate to sort column descending"
                                }
                            },
                            paging: false,
                            ajax: {
                                url: 'http://localhost:8080/matriculaservicio/webresources/mostrarviewaulas/procesar',
                                type: 'GET',
                                data: function (d) {
                                    d.token = getCookie("token");
                                    d.codiAnio = $("#cmbAnio").val();
                                }
                            },
                            columns: [
                                {data: 'codiAula'},
                                {data: 'nombAula'},
                                {data: 'nombSede'},
                                {data: 'numeAula'},
                                {data: 'codiAula',
                                    render: function (data, type, row, meta) {
                                        let objJson = {codiAula: row.codiAula, codiAnio: row.codiAnio, nombAnio: row.nombAnio, codiGrad: row.codiGrad, codiSecc: row.codiSecc, numeAula: row.numeAula};
                                        return "<button onclick=seleccionarCliente(" + JSON.stringify(objJson) + ") class=\"btn btn-primary btn-user \">Modificar</button>";
                                    }
                                }
                            ]
                        });



                        //CONTINUA CARGAR COMBOS
                        let url = "http://localhost:8080/matriculaservicio/webresources/crudanio/listar";
                        parametro = {token: getCookie("token")};
                        $.getJSON(url, parametro, function (data) {
                            let codiAnio;
                            for (const element of data.data) {
                                $("#cmbAnio").append("<option value=" + element.codiAnio + " selected>" + element.nombAnio + "</option>");
                                codiAnio = element.codiAnio;
                            }
                            table.ajax.reload();

                            url = "http://localhost:8080/matriculaservicio/webresources/crudsede/listar";
                            parametro = {token: getCookie("token")};
                            $.getJSON(url, parametro, function (data) {
                                for (const element of data.data) {
                                    $("#cmbSede").append("<option value=" + element.codiSede + " selected>" + element.nombSede + "</option>");
                                }
                                url = "http://localhost:8080/matriculaservicio/webresources/mostrarviewgrados/procesar";
                                let parametro = {token: getCookie("token")};
                                $.getJSON(url, parametro, function (data) {
                                    for (const element of data.data) {
                                        $("#cmbGrado").append("<option value=" + element.codiGrad + " selected>" + element.nombGrado + "</option>");
                                    }
                                    url = "http://localhost:8080/matriculaservicio/webresources/crudseccion/listar";
                                    parametro = {token: getCookie("token")};
                                    $.getJSON(url, parametro, function (data) {
                                        for (const element of data.data) {
                                            $("#cmbSeccion").append("<option value=" + element.codiSecc + " selected>" + element.nombSecc + "</option>");
                                        }
                                    });
                                });
                            });
                        });

                    } else {
                        $(location).attr('href', "index.html");
                    }


                });
                $('#cmbAnio').on('change', function () {
                    table.ajax.reload();
                });
                $("#btnNuevo").click(function () {
                    $("#txtAccion").val("1");
                    $("#modalTituloAula").text("Agregar Aula");
                    $("#txtAnio").val($("#cmbAnio option:selected").text());
                    $("#txtCodigo").val("AUTOMATICO");
                    $("#txtAforo").val("30");
                    $("#modalModificar").modal("show");
                });


                //CERRAR SESIÓN   
                $("#salir").click(function () {
                    $.getJSON("cerrarsesion", function (data) {});
                    $(location).attr('href', "index.html");
                });


                $("#btnAceptarCambios").click(function () {
                    let codiAula = $("#txtCodigo").val();
                    let codiAnio = $("#cmbAnio").val();
                    let codiSede = $("#cmbSede").val();
                    let codiGrad = $("#cmbGrado").val();
                    let codiSecc = $("#cmbSeccion").val();
                    let numeAula = $("#txtAforo").val();
                    if ($("#txtAccion").val() === "1") {
                        let url = "http://localhost:8080/matriculaservicio/webresources/crudaula/agregar";
                        let parametro = {token: getCookie("token"), codiSede: codiSede, codiGrad: codiGrad, codiSecc: codiSecc, codiAnio: codiAnio, numeAula: numeAula, codiUsuaAlta: codiUsua, actiAula: true,ipRegiAlta:ip,hostRegiAlta:hostname};
                        $.getJSON(url, parametro, function (data) {
                            if (data.resultado === "ok") {
                                table.ajax.reload();
                                $("#modalModificar").modal("hide");
                            } else {
                                mostrarMensaje("alertModificar", data.mensaje);
                            }
                        });
                    } else {
                        let url = "http://localhost:8080/matriculaservicio/webresources/crudaula/modificar";
                        let parametro = {token: getCookie("token"), codiAula: codiAula, codiSede: codiSede, codiGrad: codiGrad, codiSecc: codiSecc, codiAnio: codiAnio, numeAula: numeAula, codiUsuaModi: codiUsua, actiAula: true,ipRegiModi:ip,hostRegiModi:hostname};
                        $.getJSON(url, parametro, function (data) {
                            if (data.resultado === "ok") {
                                table.ajax.reload();
                                $("#modalModificar").modal("hide");
                            } else {
                                mostrarMensaje("alertModificar", data.mensaje);
                            }
                        });
                    }
                });
                let mostrarMensaje = function (nombreid, mensaje) {
                    $("#" + nombreid).text(mensaje);
                    $("#" + nombreid).css("display", "block");
                    setTimeout(function () {
                        $("#" + nombreid).fadeOut(2000);
                    }, 2000);
                };

            });
            function seleccionarCliente(obj) {
                let url = "http://localhost:8080/matriculaservicio/webresources/mostrarviewgrados/procesar";
                let parametro = {token: getCookie("token")};
                $("#txtAccion").val("0");
                $("#txtCodigo").val(obj.codiAula);
                $("#txtAnio").val($("#cmbAnio option:selected").text());
                $("#cmbGrado").val(obj.codiGrad);
                $("#cmbSeccion").val(obj.codiSecc);
                $("#txtAforo").val(obj.numeAula);
                $("#modalTituloAula").val("Modificar Aula");
                $("#modalModificar").modal("show");



            }


            function getCookie(nombre) {
                // Obtener todas las cookies presentes en el documento
                var cookies = document.cookie.split(';');

                // Buscar la cookie por nombre
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Verificar si la cookie comienza con el nombre buscado
                    if (cookie.indexOf(nombre + '=') === 0) {
                        // Devolver el valor de la cookie
                        return decodeURIComponent(cookie.substring(nombre.length + 1));
                    }
                }

                // Si no se encuentra la cookie, devolver null
                return null;
            }
        </script>

    </body>

</html>